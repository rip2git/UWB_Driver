
#include "main.h"
#include "COMPort.h"

/// linker, misc
/// -static-libgcc -static-libstdc++

//#define init

#ifndef init

int main() {

	TON t1;
	COMPort::InitializationStruct init_str;
	init_str.baudRate = 115200;
	init_str.portName = "COM3";
	init_str.timeOut.Ms = 1000;
	init_str.timeOut.nChars = 0;
	COMPort port(&init_str);

	if (port.GetState() == COMPort::OPENED)
		cout << "opened" << endl;
	else
		cout << "error" << endl;

	unsigned long long old_t1;
	unsigned char buf[50];
	char n[10];
	n[9] = '\0';
	size_t rdb;
	int mainstate = 0;
	int distance;

	while (1) {

		switch (mainstate) {
			case 0: {
				cout << "enter ID" << endl;
				cin >> n[0];
				n[0] &= 0x0F;
				n[1] = 0;
				port.Write(n);
				port.Read(buf, 3);
				buf[3] = 0;
				cout << buf << endl;
				mainstate = 2;
			} break;
			case 1: {

				mainstate = 2;
			} break;
			case 2: {
				t1.start(0);
				mainstate = 3;
			} break;
			case 3: {
				rdb = port.Read(buf, 9);
				distance = buf[7] << 8 + buf[8] ;
				cout << t1.since() - old_t1 << endl;
				cout << distance << " cm" << endl;
				cout << endl;
				mainstate = 2;
			} break;
		}
	}
	return 0;
}

#else

int main() {

	TON t1;
	COMPort::InitializationStruct init_str;
	init_str.baudRate = 115200;
	init_str.portName = "COM3";
	init_str.timeOut.Ms = 1000;
	init_str.timeOut.nChars = 0;
	COMPort port(&init_str);

	if (port.GetState() == COMPort::OPENED)
		cout << "opened" << endl;
	else
		cout << "error" << endl;

	unsigned long long old_t1;
	unsigned char buf[50];
	char n[10];
	n[9] = '\0';
	size_t rdb;
	int mainstate = 0;

	while (1) {

		switch (mainstate) {
			case 0: {
				cout << "enter ID" << endl;
				cin >> n[0];
				n[0] &= 0x0F;
				n[1] = 0;
				port.Write(n);
				port.Read(buf, 3);
				buf[3] = 0;
				cout << buf << endl;
				memcpy(n, "023456789", 9);
				mainstate = 2;
			} break;
			case 1: {

				mainstate = 2;
			} break;
			case 2: {
				Sleep(490);
				port.Write(n);
				t1.start(0);
				old_t1 = t1.since();
				mainstate = 3;
			} break;
			case 3: {
				rdb = port.Read(buf, sizeof(buf));
				cout << t1.since() - old_t1 << endl;
				for (size_t i = 0; i < rdb; ++i)
					cout << static_cast<char>(buf[i]);
				cout << endl;
				mainstate = 2;
			} break;
		}
	}





	return 0;
}


#endif
