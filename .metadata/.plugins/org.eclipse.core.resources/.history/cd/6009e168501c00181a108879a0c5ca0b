
#include "main.h"
#include "COMPort.h"

/// linker, misc
/// -static-libgcc -static-libstdc++

int main() {

	TON t1;
	COMPort::InitializationStruct init_str;
	init_str.baudRate = 115200;
	init_str.portName = "COM3";
	init_str.timeOut.Ms = 1000;
	init_str.timeOut.nChars = 0;
	COMPort port(&init_str);

	unsigned long long old_t1;
	unsigned char buf[50];
	char n[10];
	n[9] = '\0';
	size_t rdb;
	int mainstate = 0;

	while (1) {

		switch (mainstate) {
			case 0: {
				cout << "enter ID" << endl;
				cin >> n[0];
				n[1] = 0;
				port.Write(n);
				port.Read(buf, 4);
				mainstate = 1;
			} break;
			case 1: {
				memcpy(n, "123456789", 9);
				mainstate = 2;
			} break;
			case 2: {
				Sleep(490);
				port.Write(n);
				t1.start(0);
				old_t1 = t1.since();
				mainstate = 3;
			} break;
			case 3: {
				rdb = port.Read(buf, sizeof(buf));
				cout << t1.since() - old_t1 << endl;
				for (size_t i = 0; i < rdb; ++i)
					cout << static_cast<char>(buf[i]);
				cout << endl;
				mainstate = 2;
			} break;
		}
	}





	return 0;
}
